version: '1'

environment:
  DOCKER_RUBY_VERSION: 2.6
  RUBY_IMAGE_TAG: 2.6.2
  POSTGRES_IMAGE_TAG: 11.2
  COMPOSE_FILE_EXT: development
  RAILS_ENV: test

compose:
  files:
    - docker/docker-compose.yml
    - docker/docker-compose.${COMPOSE_FILE_EXT}.yml
  project_name: yandex_photo_storage${RAILS_ENV}

interaction:
  sh:
    service: app

  irb:
    service: app
    command: irb

  bundle:
    service: app
    command: bundle

  rake:
    service: app
    command: bundle exec rake

  appraisal:
    service: app
    command: bundle exec appraisal

  rspec:
    service: app
    command: bundle exec appraisal bundle exec rspec

  clean:
    service: app
    command: rm -f Gemfile.lock gemfiles/*.gemfile.*

  rails:
    service: app
    command: bundle exec appraisal rails5.2 bundle exec ./bin/rails

  rails_console:
    service: app
    command: bundle exec appraisal rails5.2 bundle exec ./bin/console

  psql:
    service: db
    command: psql --username=postgres --dbname=docker --host=db

provision:
  - docker volume create --name bundler_data
  - dip clean
  - dip bundle install
  - dip appraisal install
